name: Update Azure West Europe IPs
on:
  schedule:
    - cron: '0 0 * * 1' # Runs every Monday at midnight
  workflow_dispatch: # Allows you to run it manually

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Fetch and Filter Azure IPs
        run: |
          # 1. Download the official Microsoft IP list
          # Note: Microsoft changes the download link often, so we scrape the landing page for the actual JSON link
          DOWNLOAD_URL=$(curl -sL "https://www.microsoft.com/en-us/download/details.aspx?id=56519" | grep -oE "https://download.microsoft.com/download/[^\"]+ServiceTags_Public_[0-9]+\.json" | head -n 1)
          curl -sL "$DOWNLOAD_URL" -o azure.json

          # 2. Extract "WestEurope" IPs and format for Clash
          echo "payload:" > azure_west_europe.yaml
          jq -r '.values[] | select(.name=="AzureCloud.westeurope") | .properties.addressPrefixes[]' azure.json | sed 's/^/  - IP-CIDR,/' | sed 's/$/,no-resolve/' >> azure_west_europe.yaml

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add azure_west_europe.yaml
          git commit -m "Automated update of Azure West Europe IPs" || exit 0
          git push